---
description:
globs:
  - "config/config.yaml"
  - "DEVELOPMENT_RULES.md"
  - "run.py"
alwaysApply: true
---

## 1. 프로젝트 개요

- **목표**: OKX API를 사용하여 암호화폐 거래 전략을 백테스팅하고, 결과를 엑셀 파일로 출력합니다.
- **핵심 기능**:
    - `PositionSet` 개념을 도입하여 롱/숏 포지션 및 "물린" 포지션을 분리하여 관리합니다.
    - 백테스팅에 필요한 모든 설정은 `config/config.yaml` 파일을 통해 관리합니다.
    - `DEVELOPMENT_RULES.md`에 정의된 코딩 스타일 및 개발 가이드라인을 준수합니다.

## 2. 주요 파일 및 디렉토리

- `run.py`: 백테스팅을 실행하는 메인 스크립트입니다.
- `config/config.yaml`: API 키, 백테스트 기간, 전략 변수 등 모든 설정을 관리하는 파일입니다. **이 파일은 직접 수정지 않고, 사용자에게 수정을 안내해야 합니다.**
- `DEVELOPMENT_RULES.md`: 코딩 스타일, 네이밍 컨벤션, 에러 처리, 로깅, 테스트 등 상세한 개발 가이드라인을 포함합니다. **모든 코드는 이 문서의 규칙을 따라야 합니다.**
- `ref/`: 참고용 파일들이 위치하며, 실제 프로젝트 코드에는 포함되지 않습니다.
- `logs/`: 로그 파일이 저장되는 디렉토리입니다.
- `gemini.md`: Gemini와의 협업을 위한 가이드 파일입니다.

## 3. 개발 및 실행 환경

- **실행 방법**: `python run.py` 명령어로 백테스트를 실행합니다. (별도의 인자 없이 `config.yaml` 파일 사용)
- **의존성**: `requirements.txt` 파일에 명시된 라이브러리를 사용합니다.
- **데이터**: OKX API를 통해 과거 OHLCV 데이터를 가져와 사용합니다. SMA와 같은 지표 계산에 필요한 충분한 과거 데이터를 포함해야 합니다.


## 4. 기본 로직 

- **정의**: 무한매수법 혹은 떨사오팔을 기본으로 하는 전략
- **동작**:
    1. 매수시점 -> 포지션 생성
       - 상승 추세(이평선 정배열,  장기 이평선 전일보다 상승) 일때 종가가 전일 보다 하락시 롱 진입 
       - 하락 추세(이평선 역배열,  장기 이평선 전일보다 하락) 일때 종가가 전일 보다 상승시 숏 진입
       -  매수된 거래는 트랜잭션으로 처리되며, 기존 position 동일 side에 통합된다.           
    2. 매도시점 -> 포지션 청산
       - 매도주문은 매수 채결시점에서 포지션/포지션셋 기준으로 지정가(평균진입가*목표수익율) 매도 주문을 한다. 
       - 매수시점에서 이전에 있던 익절주문은 취소하고, 평균진입가를 다시 계산 후 익절주문을 한다.
       - 매 캔들마다 각 주문의 익절 여부를 채크한다. 
    3. 거래수수료 및 펀딩피 등의 각종 수수료는 config.yaml 에서 %로 설정하고, 계산 과정에서는 BTC 단위로 계산하여 적용한다. 
       - 거래수수료 : 포지션 생성 / 청산 모두 각각 포지션의 크기에 비례하여 적용됨
       - 펀딩피 : 총 포지션 기준으로 적용되며, UTC 기준 [0, 8, 16]에 적용함
    5. 주요용어 정리 
        - 마진 :  선물 계약을 체결할 때 반드시 예치해야 하는 보증금 또는 담보금
        - 포지션크기 : 선물 계약 금액 (포지션 크기 = 마진 × 레버리지)
    6. 최대 매수치 제한 
        - config.yaml에서 position_set /  max_long_set / max_short_set  설정함. 
        - 포지션크기가 max_long_set / max_short_set와 같고, 현재 롱/숏 포지션 각각의 크기가 
           (position_set_size - 1) * position_size 이면 추가로 신규 포지션 생성이 불가함 
    7. Crypto Margin 선물 거래 청산가치 미실행 가치 계산 로직 수정 : 인버스 가치 계약 (Inverse Contract) 
       (2025.07.12 변경)
        1) USDT-Margined /  USDC-Margined
            - 롱(BTC) : Position크기(amount:BTC) * 진입가격 *(청산가격 -진입가격) / 청산가격
            - 숏(BTC) : Position크기(amount:BTC) * 진입가격 *(진입가격 - 청산가격) / 청산가격
        2) Crypto-Margined
            - 롱(BTC) : Position크기(amount:BTC) * 진입가격 * (1/진입가격 - 1/청산가격)
            - 숏(BTC) : Position크기(amount:BTC) * 진입가격 * (1/청산가격 - 1/진입가격)
    8. 가중평균 계산 로직 수정 (2025.07.12 변경)
        1) USDT-Margined /  USDC-Margined
            - 평균가격 = (현재 규모 * 진입 가격 + 추가된 규모 * 추가된 규모의 진입 가격) /(현재 규모 + 추가된 규모)

        2) Crypto-Margined
            - 평균가격 = (현재 규모 + 추가된 규모) / (현재 규모 / 진입 가격 + 추가된 규모 / 추가된 규모의 진입 가격)

## 5. 핵심 로직 (`PositionSet`)

- **정의**: 동일 포지션(롱/숏) 내에서 특정 크기 이상으로 누적된 거래들을 하나의 묶음(`PositionSet`)으로 관리하는 가상 포지션입니다.
- **동작**:
    1.  반복적인 매수/매도로 포지션 크기가 설정된 임계값을 초과하면, 해당 거래들을 모아 하나의 `PositionSet`을 생성합니다.
    2.  `PositionSet`의 평균 진입 가격은 Position Size가 position_set_size가 되어 PositionSet으로 이관될때의 평균진입 가격 사용 ( 8. 가중평균 계산 로직 기반하여 계산됨 )
    3.  `PositionSet`은 독립적인 단위로 관리되며, 자체적인 평균 진입 가격을 기준으로 익절/손절 여부를 판단합니다.
    4.  새로운 거래는 기존 `PositionSet`과 분리되어 새로운 포지션으로 관리됩니다.
    5.  포지션 진입(매수), 청산(매도) 주문은 지정가로 진행합니다. 
    6.  SMA 지표 계산을 위해 `long_period` (기본값 720) 만큼의 과거 데이터가 필요하며, 이 기간 동안은 거래 신호가 발생하지 않습니다. 따라서 백테스트 시작 시점에 충분한 과거 데이터가 제공되어야 합니다. 
    6.  config startdate에 로직이 적용될 수 있도록, 실행전 과거 데이터가 있어야 합니다. 
        short_period: 24  # 단기 이동평균 기간 /   long_period: 720   # 장기 이동평균 기간
        이므로 최대치인 720개의 봉이 사전에 있야 합니다.
- **설정**: `PositionSet`의 최대 개수 (롱/숏 별도) 및 크기 임계값은 `config.yaml`에서 설정합니다.

## 6. Gemini 협업 가이드

1.  **파일 참조**: 코드 수정 또는 분석 요청 시, 관련된 파일(`run.py`, `config/config.yaml` 등)을 함께 알려주시면 더 정확하고 빠른 작업이 가능합니다.
2.  **규칙 준수**: 모든 코드 작성 및 수정은 `DEVELOPMENT_RULES.md`의 가이드라인을 따릅니다.
3.  **`config.yaml` 수정**: `config.yaml` 파일의 내용은 제가 직접 수정하지 않습니다. 변경이 필요한 경우, 어떤 값을 어떻게 변경해야 하는지 사용자에게 명확하게 설명하고 안내하겠습니다.
4.  **점진적 개발**: "정확한 엑셀 파일 양식과 데이터 출력"을 첫 목표로 하며, 데이터 정합성 검증은 사용자가 엑셀 파일을 통해 직접 수행합니다.
5.  **언어**: 한국어 ( 대화 및 코드내 주석)
6.  **OS**: Windows11
7.  **시간대** : 대한민국 서울 기준
8.  **백테스트 실행 및 검증**: 별도의 요청이 없다면 직접 `run.py` 실행한다. 
9.  **git commit 작업** : 커밋 메시지 내용을 파일로 작성하여 커밋을 진행하고 커밋 후 해당 파일을 삭제한다. 


## 7. 날짜별 진행사항

### 7.1. 완료된 사항 (2025.07.02)

1.  **정합성 확보**: 기존 Cursor AI와의 작업으로 백테스팅 프로세스의 기본 정합성 확보.
2.  **구조화 적용**: 단일 파일이었던 스크립트의 주요 기능을 `src` 디렉토리 하위 모듈로 분리하고 클래스 기반으로 리팩토링 완료.
3.  **거래수익 계산 로직 수정**: `is_closed` 플래그 설정 순서를 조정하여 실현 손익(PnL)이 0으로 계산되던 버그를 수정했습니다.
4.  **동시 익절 처리 로직 개선**: 한 캔들 내에서 여러 거래가 발생했을 때, 마지막 거래만 기록되던 문제를 해결하여 모든 거래가 합산되도록 수정했습니다.
5.  **단위 테스트 환경 정리**: 테스트 과정에서 추가되었던 파일(`tests` 디렉토리, `pytest.ini`)과 코드 변경 사항을 정리하고, 프로덕션 코드에 영향을 주지 않도록 원상 복구했습니다.

### 7.2. 진행 내역 (2025.07.04 08:47)

1.  **`run_live.py` 실행 오류 수정**: `datetime` 모듈이 임포트되지 않아 발생한 오류를 수정했습니다.
2.  **`gemini.md` 업데이트**: 진행 내역을 시간 단위로 기록했습니다.
3.  **주요 구현 단계 완료 상태 업데이트**: `gemini.md`에 명시된 주요 구현 단계의 완료 상태를 갱신했습니다.

### 7.3. 진행 내역 (2025.07.05)

1.  **백테스트 리포트 기간 오류 수정**:
    *   **문제점**: 백테스트 결과 리포트(엑셀)에 `config.yaml`에 설정된 기간(예: 3개 캔들)보다 많은 데이터(예: 11개 캔들)가 포함되는 오류를 발견했습니다.
    *   **원인 분석**: 기술 지표(SMA 등) 계산을 위해 가져온 과거 데이터까지 필터링 없이 백테스트 루프에서 처리하고 리포트에 포함시키는 것이 원인이었습니다.
    *   **해결**: `src/main.py`와 `src/trade_analyzer.py`를 수정하여, 지표 계산에 필요한 전체 데이터(`all_data`)와 실제 백테스트를 수행할 기간의 데이터(`backtest_data`)를 명확히 분리했습니다. `main` 함수에서 `start_date`와 `end_date`를 기준으로 데이터를 정확히 필터링하고, `trade_analyzer`는 필터링된 데이터를 기반으로 백테스트를 실행하도록 변경했습니다.
    *   **결과**: 이 수정을 통해 백테스트 리포트에 정확히 설정된 기간의 데이터만 포함되도록 문제를 해결했습니다.

### 7.4. 진행 내역 (2025.07.05 22:00)

1.  **전략 진입 로직 개선**:
    *   `gemini.md`에 정의된 "떨사오팔" 전략(상승 추세 중 하 시 롱, 하락 추세 중 상승 시 숏)을 `src/strategy.py`의 `generate_signals` 메서드에 구현했습니다.
    *   기존의 루프 기반 신호 생성을 벡터화된 `numpy.where` 연산으로 변경하여 성능을 개선하고, 불필요한 청산 신호 로직을 제거했습니다.

2.  **거래 미기록 버그 수정**:
    *   **문제점**: 백테스트 실행 시, 매수/매도 신호가 발생해도 실제 거래가 리포트에 기록되지 않는 문제를 발견했습니다.
    *   **원인 분석**: `VirtualExchange`에서 진입 주문을 즉시 체결로 처리하여, `TradingManager`가 해당 거래를 정상적으로 인지하고 `Transaction`을 생성하지 못하는 것이 원인이었습니다. 또한, 주문 정보에서 포지션 방향(`long`/`short`)과 거래 행위(`buy`/`sell`)가 혼용되어 체결 로직에 오류가 있었습니다.
    *   **해결**:
        1.  `src/virtual_exchange.py`: 모든 주문(진입/청산)을 미체결 상태로 생성하고, `position_side` 정보를 명확히 포함하도록 수정했습니다. 또한, `process_candle_for_orders`의 체결 로직을 수정하여 `buy`/`sell` 행위에 따라 지정가 주문을 올바르게 처리하도록 변경했습니다.
        2.  `src/models.py`: `Transaction.from_ccxt_order`가 `position_side`를 명시적으로 인자로 받도록 수정했습니다.
        3.  `src/trading_manager.py`: 체결된 주문 처리 시, `virtual_exchange`로부터 `position_side` 정보를 받아 `Transaction`을 생성하도록 수정하고, `uuid` 모듈 누락으로 인한 `NameError`를 해결했습니다.
    *   **결과**: 위 수정들을 통해 신호 발생 시 거래가 정상적으로 기록되도록 문제를 해결했습니다.


### 7.5. 진행 내역 (2025.07.07)
1. 금일 목표 
    *   백테스트 주문 - 거래 - Position 정합성 검증 완료
    *   실시간 거래 단위 테스트 및 정합성 검증 시작 (1-day)
2. 수행내역
    *   order_type (open/close), order_side(LONG, SHORT) 개념 명확히 적용 (cctx_side 삭제)
    *   매도신호 정상 발생
    *   거래잔고 + 총마진 + 총 롱가치 + 총 숏가치 = 총자산   검증 완료
    *   포지션수익률 공식 수정 

### 7.6. 진행 내역 (2025.07.08)
1. 금일 목표 
    *   백테스트 정합성 테스트 완료
    *   실시간 거래 단위 테스트 및 정합성 검증 완료 (0-day)
2. 수행내역
    *   position/positionset 청산시 엑셀결과 파일에 "거래크기"가 단위 size로만 나오는 문제 : 해결완료 (11:45)

### 7.7. 진행 내역 (2025.07.15)
1.  **"미실현손익_차이" 문제 해결**:
    *   **문제점**: 백테스트 결과 엑셀 파일의 "미실현손익_차이" 컬럼 값이 0이 아닌 문제가 발생했습니다.
    *   **원인 분석**: `Position` 및 `PositionSet` 클래스의 `calculate_unrealized_pnl` 메서드에서 Crypto-Margined 포지션의 미실현 손익 계산 공식이 `gemini.md`에 명시된 공식 및 `Transaction` 클래스의 계산식과 불일치하는 것을 확인했습니다.
    *   **해결**: `src/models.py` 파일에서 `Position` 및 `PositionSet` 클래스의 Crypto-Margined 롱/숏 포지션에 대한 미실현 손익 계산 공식을 `gemini.md`에 정의된 대로 수정했습니다.
    *   **결과**: 사용자 확인 결과, "미실현손익_차이"가 소수점 넷째 자리 이상 커지지 않아 부동 소수점 연산으로 인한 미세한 오차로 판단, 문제가 해결된 것으로 결론지었습니다.
2.  **코드 커밋**: 
    *   `src/config_manager.py`, `src/models.py`, `src/okx_exchange.py`, `src/trading_manager.py` 파일의 변경사항을 커밋했습니다.
    *   `backtest_log.txt` 파일을 Git 추적에서 제외하고, `config/config.yaml`, `gemini.md` 수정, `cryptoSim` 디렉토리 및 `test/테스트가이드.md` 파일 삭제 등 현재 작업 디렉토리의 모든 변경사항을 커밋했습니다.


## 8. 향후 계획

- **리스크 관리 기능 고도화: 트레일링 스탑(Trailing Stop) 구현**
- **PositionSet 관리 로직 강화**
- **기타 전략 지표 및 진입/청산 조건 추가**
- **백테스트 기능 확장 (결과 파일 이미지 저장 등)**


## 9. 결과 엑셀 파일 컬럼 설명

`*_backtest_report.xlsx` 파일의 `시세분석` 시트는 백테스팅 과정의 상세한 데이터를 시간 순서대로 보여줍니다. 각 컬럼의 의미는 다음과 같습니다.

| 구분 | 컬럼명 | 설명 | 계산 로직 |
| --- | --- | --- | --- |
| **기본 정보** | 시간 | 데이터의 시간 (타임스탬프) | - |
| | 시가 (open) | 해당 시간의 시작 가격 | - |
| | 고가 (high) | 해당 시간의 최고 가격 | - |
| | 저가 (low) | 해당 시간의 최저 가격 | - |
| | 종가 (close) | 해당 시간의 마감 가격 | - |
| | SMA_24 | 단기 이동평균 | 24개 캔들 기준 |
| | SMA_720 | 장기 이동평균 | 720개 캔들 기준 |
| **신호 정보** | 매수신호 | 전략에 의해 매수 신호가 발생했을 때 `True` | - |
| | 매도신호 | 전략에 의해 매도 신호가 발생했을 때 `True` | - |
| **거래 정보** | 거래ID | 각 거래(진입 또는 청산)에 부여되는 고유 ID | - |
| | 거래방향 | 'long' 또는 'short' | - |
| | 거래가격 | 실제 거래가 체결된 가격 | - |
| | 거래크기 | 거래된 수량 (BTC) | - |
| | 거래수익 | 매도에 따른 확정 수익(BTC) | `인버스 가치 계약` |
| **포지션 정보** | 총 롱크기 | 현재 보유 중인 롱 포지션의 총 수량 | - |
| | 롱Set | `PositionSet`의 개수와 각 Set의 평균 진입 가격 | 예: `2(12345.67)` |
| | 총 롱진입가 | 현재 보유 중인 롱 포지션의 전체 평균 진입 가격 | - |
| | 총 롱가치 | 롱 포지션의 가치 | `trade_type에 따라 변경`  |
| | 총 숏크기 | 현재 보유 중인 숏 포지션의 총 수량 | - |
| | 숏Set | `PositionSet`의 개수와 각 Set의 평균 진입 가격 | 예: `2(12345.67)` |
| | 총 숏진입가 | 현재 보유 중인 숏 포지션의 전체 평균 진입 가격 |`trade_type에 따라 변경`|
| | 총 숏가치 | 숏 포지션의 가치 | `trade_type에 따라 변경` |
| | 포지션크기 | 보유 중인 모든 포지션의 크기 합계 | `(총 롱크기) + (총 숏크기)` |
| **계좌 및 수익률**| 포지션수익율(%) | 현재 보유 중인 모든 포지션의 미실현 수익률 | `(총 롱가치 + 총 숏가치) / (총 투입 포지션 크기 합 *100) ` |
| | 총마진(BTC) | 현재 보유 중인 모든 포지션에 사용된 증거금의 합계 | - |
| | 거래잔고(BTC) | 거래에 사용되지 않고 남아있는 증거금 (BTC) | - |
| | 총자산(BTC) | 계좌의 총 가치 | `(거래잔고) + (총마진) + (미실현 손익)` |
| | 누적수익률(%) | 백테스트 시작 시점부터 현재까지의 총 실현 수익률 | `(현재 총자산 - 초기자본) / 초기자본 * 100` |