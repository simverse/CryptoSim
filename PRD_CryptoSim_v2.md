# CryptoSim v2.0 - 제품 요구사항 문서 (PRD)

## 📋 프로젝트 개요

### 목적
기존의 복잡한 백테스팅 시스템을 하나의 통합된 파일로 재구성하여 유지보수성과 가독성을 향상시키고, 암호화폐 거래 전략의 백테스팅을 간편하게 수행할 수 있는 올인원 솔루션 제공

### 주요 목표
- **단일 파일 구조**: 모든 핵심 기능을 하나의 Python 파일로 통합
- **간편한 실행**: 최소한의 설정으로 즉시 백테스팅 가능
- **전문가 수준**: 30년 경력 개발자에게 적합한 고급 기능 제공
- **한국어 지원**: 모든 코드 주석과 로그를 한국어로 제공
- **논리적 정합성**: Look-ahead bias 없는 정확한 백테스팅 엔진

## 🎯 핵심 기능 요구사항

### 1. 데이터 관리
- **OKX API 연동**: 실시간 OHLCV 데이터 수집
- **다양한 심볼 지원**: BTC/USD:BTC (코인 정산 선물) 등 선물 거래 심볼
- **시간프레임 선택**: 1m, 5m, 15m, 1h, 4h, 1d 등
- **데이터 검증**: 누락 데이터 감지 및 처리

### 2. 전략 엔진
- **SMA 크로스오버**: 단기/장기 이동평균 교차 전략
- **신호 생성**: 매수/매도/보유 신호 자동 생성
- **확장 가능성**: 새로운 전략 추가 용이한 구조

### 3. 백테스팅 엔진
- **포지션 관리**: 롱/숏 포지션 동시 지원
- **리스크 관리**: 손절/익절 자동 실행 (Look-ahead bias 방지 적용)
- **수수료 계산**: 거래수수료 및 펀딩피 반영
- **레버리지**: 1~100배 레버리지 지원 (하드코딩 제거, 변수화 완료)
- **논리적 진입/청산**: 같은 봉에서 진입 후 즉시 청산 방지 로직 적용

### 4. 성과 분석
- **수익률 분석**: 총수익률, 연간수익률, 샤프비율
- **리스크 지표**: 최대낙폭(MDD), 소르티노비율
- **거래 통계**: 승률, 평균수익/손실, 수익인수
- **시각화**: Excel 리포트 자동 생성

## 🔧 기술 요구사항

### 1. 아키텍처
```
CryptoSim_v2.py (단일 파일 구조)
├── 설정 관리 (ConfigManager)
├── 데이터 수집 (DataFetcher) 
├── 전략 엔진 (StrategyEngine)
├── 백테스팅 (BacktestEngine)
├── 성과 분석 (PerformanceAnalyzer)
└── 리포트 생성 (ReportGenerator)
```

### 2. 의존성 최소화
- **필수 라이브러리만 사용**: ccxt, pandas, numpy, pyyaml
- **표준 라이브러리 활용**: datetime, logging, pathlib
- **선택적 의존성**: plotly (시각화), openpyxl (Excel)

### 3. 성능 요구사항
- **메모리 효율성**: 대용량 데이터 스트리밍 처리
- **실행 속도**: 2000시간 데이터 1분 이내 처리
- **안정성**: 99% 이상 성공률

## 📊 사용자 인터페이스

### 1. 명령줄 인터페이스 (CLI)
```bash
python cryptosim_v2.py --symbol BTC/USDT:USDT --timeframe 1h --hours 2000
```

### 2. 주요 파라미터
| 파라미터 | 설명 | 기본값 | 예시 |
|---------|------|--------|------|
| --symbol | 거래 심볼 | BTC/USD:BTC | ETH/USD:ETH |
| --timeframe | 시간프레임 | 1h | 1m, 5m, 15m, 1h, 4h, 1d |
| --hours | 백테스트 기간 | 2000 | 1000, 5000 |
| --initial-balance | 초기 자본 (BTC) | 1.0 | 0.5, 2.0 |
| --leverage | 레버리지 | 5 | 1, 10, 20 |
| --short-ma | 단기 이동평균 | 24 | 12, 50 |
| --long-ma | 장기 이동평균 | 720 | 200, 1000 |
| --stop-loss-pct | 손절률 | 1.0 (100%) | 0.02 (2%), 0.05 (5%) |
| --take-profit-pct | 익절률 | 0.02 (2%) | 0.01 (1%), 0.03 (3%) |

### 3. 출력 형태
- **콘솔 로그**: 실시간 진행 상황 및 결과 요약
- **Excel 리포트**: 상세 거래내역 및 성과분석
- **설정 파일**: YAML 형태의 재사용 가능한 설정

## 🔒 보안 및 안전성

### 1. API 키 관리
- **환경변수 우선**: API 키는 환경변수로 설정 권장
- **설정파일 지원**: 개발 편의를 위한 config.yaml 지원
- **샌드박스 모드**: 기본적으로 테스트 환경 사용

### 2. 에러 처리
- **네트워크 오류**: 자동 재시도 및 백오프
- **데이터 오류**: 누락/비정상 데이터 감지 및 처리
- **API 한도**: 요청 제한 자동 관리

### 3. 로깅
- **상세 로깅**: 모든 거래 및 오류 기록
- **한국어 메시지**: 이해하기 쉬운 한국어 로그
- **파일 저장**: logs/ 디렉토리에 자동 저장

## 📈 성능 지표

### 1. 백테스팅 결과
- **수익률**: 총수익률, 연간수익률, 월간수익률
- **리스크**: 최대낙폭, 변동성, 샤프비율, 소르티노비율
- **거래**: 총거래수, 승률, 평균보유기간, 수익인수

### 2. 시스템 성능
- **처리속도**: 시간당 봉 처리 개수
- **메모리 사용량**: 피크 메모리 사용량
- **성공률**: 오류 없이 완료되는 백테스트 비율

## 🚀 구현 우선순위

### Phase 1: 핵심 기능 (1주차)
1. ✅ 설정 관리 시스템
2. ✅ OKX 데이터 수집
3. ✅ SMA 크로스오버 전략
4. ✅ 기본 백테스팅 엔진

### Phase 2: 고급 기능 (2주차)
1. ✅ 포지션 관리 고도화 (Look-ahead bias 해결)
2. ✅ 리스크 관리 시스템 (익절/손절 로직 개선)
3. ✅ 성과 분석 강화 (데이터 기록 로직 수정)
4. ✅ Excel 리포트 생성 (완료)

### Phase 3: 최적화 및 확장 (3주차)
1. 🔄 성능 최적화 (대용량 데이터 처리)
2. 🔄 메모리 효율성 개선
3. ✅ 에러 처리 강화 (Look-ahead bias 해결)
4. ✅ 문서화 업데이트 (PRD v2.1 완성)
5. ⏳ 추가 전략 지원 (RSI, MACD 등)
6. ⏳ 실시간 모니터링 기능

## 🔧 백테스트 로직 개선사항

### 1. Look-ahead Bias 문제 해결
**문제점**: 같은 봉에서 종가로 진입한 후 동일 봉의 고가/저가로 즉시 익절/손절하는 비논리적 로직
- 예시: 2025-01-01 00:00:00에 $94,192.7(종가)로 숏 진입 → 같은 봉 저가 $91,933.0으로 즉시 익절

**해결방안**:
- 진입한 거래는 다음 봉부터 익절/손절 체크 시작
- `_check_position_take_profit()` 및 `_check_position_set_take_profit()`에서 같은 봉 진입 거래 제외
- 타임스탬프 문자열 비교로 같은 봉 여부 판단

### 2. 레버리지 하드코딩 제거
**문제점**: `margin_per_trade = position_size / 5`에서 레버리지가 하드코딩됨

**해결방안**:
- `margin_per_trade = position_size / leverage`로 변수화
- 설정 파일에서 레버리지 값 동적 적용

### 3. 데이터 기록 로직 개선
**문제점**: 
- 진입 후 즉시 청산된 거래의 정보가 Excel에 기록되지 않음
- 숏가치/롱가치 계산 공식 불일치

**해결방안**:
- 실제 거래 생성 여부 확인 후 데이터 기록
- 숏가치 = 숏크기 + 숏 PnL, 롱가치 = 롱크기 + 롱 PnL로 통일
- 디폴트 값 제거하여 설정 누락 시 명시적 에러 발생

### 4. 설정값 최적화
**주요 변경사항**:
- 심볼: `BTC/USDT:USDT` → `BTC/USD:BTC` (코인 정산 선물)
- 손절률: `stop_loss_pct: 0.02` → `stop_loss_pct: 1.0` (사실상 비활성화)
- 레버리지: 기본값 1 → 5배로 변경

### 5. 포지션 크기 계산 정확성
**개선사항**:
- 포지션크기 = 초기자본 × 포지션비율 × 레버리지
- 마진 = 포지션크기 / 레버리지
- 정확한 BTC 단위 계산 적용

### 6. 거래 수익 계산 오류 수정
**문제점**:
- 거래 청산 시, 손익을 계산하기 전에 거래 상태를 `is_closed = True`로 먼저 설정하여 모든 거래의 실현 손익(PnL)이 수수료를 제외하고 0으로 계산되는 오류 발생.

**해결방안**:
- `Transaction.close_transaction` 메소드 내에서 손익을 먼저 계산한 후, 거래 상태를 `is_closed`로 변경하도록 코드 실행 순서 조정.

### 7. 동시 익절 처리 오류 수정
**문제점**:
- 한 캔들(시간봉) 내에서 `Position`과 `PositionSet`이 동시에 익절될 경우, 마지막으로 청산된 거래의 정보만 기록되고 이전 거래 정보는 덮어쓰여지는 문제 발생.

**해결방안**:
- `Backtester` 클래스 내에서 청산된 거래 정보를 단일 변수가 아닌 리스트(`last_closed_trades`)로 관리.
- 데이터 기록 시, 해당 리스트에 있는 모든 거래 정보를 합산하여 `거래크기`와 `거래수익`에 정확히 반영하고, 기록 후 리스트를 초기화하도록 로직 개선.

## 📋 검수 기준

### 1. 코드 품질
- **가독성**: 명확한 변수명과 함수명 (한국어 주석)
- **모듈성**: 각 기능별 클래스 분리
- **재사용성**: 설정 파일을 통한 유연한 파라미터 조정
- **확장성**: 새로운 전략 추가 용이

### 2. 기능 검증
- **정확성**: 기존 시스템 대비 동일한 백테스팅 결과
- **완성도**: 모든 핵심 기능 정상 동작
- **안정성**: 다양한 시장 조건에서 오류 없이 실행
- **성능**: 요구사항 충족

### 3. 사용자 경험
- **간편성**: 최소한의 설정으로 즉시 실행 가능
- **명확성**: 이해하기 쉬운 결과 보고서
- **신뢰성**: 일관된 결과 제공
- **확장성**: 사용자 요구사항에 따른 커스터마이징 가능

---

**작성일**: 2025년 6월 27일  
**최종 업데이트**: 2025년 7월 2일  
**버전**: 2.2
**담당자**: CryptoSim 개발팀  
**주요 업데이트**: 백테스트 로직 정합성 문제 해결 및 Look-ahead bias 개선, PnL 계산 오류 수정 